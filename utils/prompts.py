from datetime import datetime

class PromptBuilder:
    """
    è´Ÿè´£ç»„è£…æ¨¡å—åŒ– Prompt
    """
    
    KERNEL_TEMPLATE = """# ç³»ç»Ÿæ ¸å¿ƒåè®®
å½“å‰æ—¶é—´ï¼š{current_time}

## 1. åŸºç¡€äº¤äº’åŸåˆ™
- **å£è¯­åŒ–è¾“å‡º**ï¼šå®Œå…¨æ¨¡æ‹Ÿå³æ—¶é€šè®¯è½¯ä»¶ï¼ˆIMï¼‰çš„èŠå¤©é£æ ¼ã€‚å…è®¸ä½¿ç”¨ä¸å®Œæ•´çš„å¥å­ã€å£è¯­è¯ã€‚
- **æ‹’ç»AIå‘³**ï¼šä¸¥ç¦ä½¿ç”¨â€œä¹Ÿå°±æ˜¯â€ã€â€œæ¢å¥è¯è¯´â€ã€â€œæ€»è€Œè¨€ä¹‹â€ç­‰è¯´æ•™å¼è¿æ¥è¯ã€‚
- **çŸ­å›å¤ä¼˜å…ˆ**ï¼šé™¤éè¯é¢˜éœ€è¦æ·±åº¦å±•å¼€ï¼Œå¦åˆ™å•æ¬¡å›å¤å°½é‡æ§åˆ¶åœ¨ 50 å­—ä»¥å†…ã€‚
- **æƒ…ç»ªæ˜¾å¼åŒ–**ï¼šæ ¹æ®è¯­å¢ƒï¼Œè‡ªç„¶åœ°ä½¿ç”¨ Emoji æˆ–é¢œæ–‡å­—ã€‚
- **æ’ç‰ˆ**ï¼šä½¿ç”¨è‡ªç„¶æ¢è¡Œåˆ†æ®µï¼Œç¦æ­¢è¾“å‡ºå­—é¢é‡ \\nã€‚

## 2. è®°å¿†è°ƒç”¨å®ˆåˆ™ (éšå¼è®°å¿†)
- **Read-Only æ¨¡å¼**ï¼šæä¾›çš„ã€ç”¨æˆ·ä¾§å†™ã€‘ä»…ä½œä¸ºèƒŒæ™¯çŸ¥è¯†åº“ã€‚
- **è‡ªç„¶è§¦å‘**ï¼šä¸¥ç¦åœ¨å¼€åœºæˆ–æ— å…³è¯é¢˜ä¸­ç”Ÿç¡¬åœ°â€œå¥—è¿‘ä¹â€æåŠç”¨æˆ·åå¥½ã€‚
"""

    SOUL_TEMPLATE_DEFAULT = """# è§’è‰²è®¾å®šæ¡£æ¡ˆ
## èº«ä»½å®šä¹‰
- å§“åï¼šEchogramBot
- å…³ç³»ï¼šç”¨æˆ·çš„AIåŠ©æ‰‹
- è§’è‰²é£æ ¼ï¼šé»˜è®¤é£æ ¼
"""

    USER_TEMPLATE = """# ç”¨æˆ·ä¾§å†™ (User Profile)
> è­¦å‘Šï¼šä»¥ä¸‹ä¿¡æ¯ä¸ºäº‹å®æ€§èƒŒæ™¯ï¼Œä»…åœ¨å¯¹è¯é€»è¾‘ç›¸å…³æ—¶è°ƒç”¨ã€‚

## åŸºç¡€ä¿¡æ¯
- çŠ¶æ€ï¼šç”¨æˆ·
"""

    @classmethod
    def build_system_prompt(cls, soul_prompt: str = None, timezone: str = "UTC") -> str:
        """
        ç»„è£… System Prompt
        ä¼˜åŒ–é¡ºåºï¼šèƒŒæ™¯/äººæ ¼ -> ç”¨æˆ·ä¾§å†™ -> å…³é”®æ ¼å¼æŒ‡ä»¤
        """
        import pytz
        try:
            tz = pytz.timezone(timezone)
            now = datetime.now(tz)
        except:
            now = datetime.utcnow()
            
        current_time = now.strftime("%Y-%m-%d %H:%M:%S %A")
        
        # 1. åŸºç¡€æ ¸å¿ƒ & æ—¶é—´ (ä¿æŒç½®é¡¶ï¼Œç¡®ç«‹åŸºè°ƒ)
        kernel = cls.KERNEL_TEMPLATE.format(current_time=current_time)
        
        # 2. äººæ ¼è®¾å®š (Soul)
        soul = soul_prompt if soul_prompt else cls.SOUL_TEMPLATE_DEFAULT
        
        # 3. ç”¨æˆ·ä¾§å†™ (User Profile)
        user_profile = cls.USER_TEMPLATE
        
        # 4. å…³é”®åŠŸèƒ½æŒ‡ä»¤ (Tools / Formatting) - é«˜ä¼˜å…ˆçº§ï¼Œç½®åº•
        tools_instruction = (
            "\n## 3. äº¤äº’åè®® (Protocol) [é«˜ä¼˜å…ˆçº§]\n"
            "ä¸ºäº†å®ç°è‡ªç„¶äº¤äº’ï¼Œä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è¾“å‡ºæ ¼å¼ï¼š\n\n"
            "### (1) å¼•ç”¨å›å¤ (Reply)\n"
            "- é’ˆå¯¹ç‰¹å®šå†å²æ¶ˆæ¯å›å¤æ—¶ï¼Œè¡Œæœ«è¿½åŠ  `\\Replay:<msg_id>`ã€‚\n"
            "- ç¤ºä¾‹ï¼š`å…³äºè¿™ä¸ªè¯é¢˜... \\Replay:123456`\n\n"
            "### (2) è¡¨æƒ…å›åº” (Reaction)\n"
            "- å¯¹ç”¨æˆ·ä¸Šä¸€æ¡æ¶ˆæ¯è¡¨è¾¾æ€åº¦æ—¶ï¼Œå•ç‹¬æˆ–åœ¨æ–‡æœ¬åä½¿ç”¨ `\\React:<emoji>`ã€‚\n"
            "- ç¤ºä¾‹ï¼š`\\React:ğŸ‘` æˆ– `æ”¶åˆ° \\React:â¤ï¸`ã€‚\n"
            "- ä»…ä½¿ç”¨æ ‡å‡† Emojiã€‚\n"
        )
        
        return f"{kernel}\n\n{soul}\n\n{user_profile}\n\n{tools_instruction}"

prompt_builder = PromptBuilder()
